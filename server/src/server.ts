import {WebSocketServer} from 'ws';

const wss = new WebSocketServer({port: 8080});

const paramsData = [
    { id: '1', lat: 49.9935, lon: 36.2304, direction: 43 },
    { id: '2', lat: 49.995,  lon: 36.232,  direction: 44 },
    { id: '3', lat: 49.991,  lon: 36.228,  direction: 45 },
    { id: '4', lat: 49.989,  lon: 36.225,  direction: 46 },
    { id: '5', lat: 49.997,  lon: 36.235,  direction: 47 },
]

wss.on("connection", (ws, req) => {
    console.log("new  client connect")
    const interval = setInterval(() => {

        const CENTER_LAT = 49.9935
        const CENTER_LON = 36.2304

        const MIN_LAT = CENTER_LAT - 0.01
        const MAX_LAT = CENTER_LAT + 0.01
        const MIN_LON = CENTER_LON - 0.01
        const MAX_LON = CENTER_LON + 0.01

        paramsData.forEach((elem)=>{
            elem.lon += (Math.random() - 0.5)* 0.001;
            elem.lat += (Math.random() - 0.5)* 0.001;
        })


        let data = paramsData.map((elem) => {
            return {
                id: elem.id,
                lat: Math.max(MIN_LAT, Math.min(MAX_LAT, elem.lat)),
                lon:  Math.max(MIN_LON, Math.min(MAX_LON, elem.lon)),
                direction: elem.direction
            }
        })
  const filtered =  data.filter(() => Math.random() > 0.1)
        console.log(filtered)
            ws.send(JSON.stringify(filtered))
    }, 1000)

    ws.on("close", () => {
        clearInterval(interval)
    })
})

// ws ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ö–û–ù–ö–†–ï–¢–ù–´–ú –∫–ª–∏–µ–Ω—Ç–æ–º
// üëâ —á–µ—Ä–µ–∑ –Ω–µ–≥–æ –º—ã:
//
//  send
//
// close
//
// —Å–ª—É—à–∞–µ–º close
//
// req ‚Äî HTTP request
// üëâ –Ω—É–∂–µ–Ω –¥–ª—è:
//
//     —á—Ç–µ–Ω–∏—è query (?key=)
//
// –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

// –°–µ—Ä–≤–µ—Ä:
//
//     ¬´–Ø –ø—Ä–∏–Ω–∏–º–∞—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è¬ª
//
// –ö–ª–∏–µ–Ω—Ç (SocketService):
//
// ¬´–Ø –ø–æ–¥–∫–ª—é—á–∞—é—Å—å¬ª


// 5Ô∏è‚É£ –ö–∞–∫ –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å –ö–õ–ò–ï–ù–¢ –≤ –≥–æ–ª–æ–≤–µ (–±–µ–∑ –∫–æ–ø–∏–ø–∞—Å—Ç–∞)
// ‚ùì –ö—Ç–æ —è?
//
//     –Ø ‚Äî SocketService
//
// ‚ùì –ß—Ç–æ —è –∏—Å–ø–æ–ª—å–∑—É—é?
//
// üëâ WebSocket, –∞ –ù–ï WebSocketServer
//
// ‚ùì –ì–¥–µ —è —Ä–∞–±–æ—Ç–∞—é?
//
// üëâ –≤ –±—Ä–∞—É–∑–µ—Ä–µ


// –ß—Ç–æ –î–û–õ–ñ–ï–ù –¥–µ–ª–∞—Ç—å WebSocket —Å–µ—Ä–≤–µ—Ä?
//
//     –°–µ—Ä–≤–µ—Ä:
//
//     —Å–ª—É—à–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
//
// –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤
//
// —à–ª—ë—Ç –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞–º


//     [ Client (Browser) ]
// |
// | new WebSocket()
// | connect()
//        ‚ñº
// [ WebSocketServer ]
// |
// | connection event
//        ‚ñº
// [ ws (client socket) ]
// |
// | send(JSON)
//        ‚ñº
// [ SocketService ]
// |
// | upsert()
//        ‚ñº
// [ ObjectsStore ]


// üß† –ö–æ—Ä–æ—Ç–∫–∞—è –º–∞–Ω—Ç—Ä–∞ (–∑–∞–ø–æ–º–Ω–∏ –Ω–∞–≤—Å–µ–≥–¥–∞)
//
// üîå –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
//
// üö™ –°–µ—Ä–≤–µ—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç
//
// üì° –°–µ—Ä–≤–µ—Ä —à–ª—ë—Ç
//
// üß† Store —Ä–µ—à–∞–µ—Ç
//
// üé® UI —Ä–∏—Å—É–µ—Ç

// SocketService
// üîå –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (connect)
//
// üëÇ —Å–ª—É—à–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
//
// üì¶ –ø–µ—Ä–µ–¥–∞—ë—Ç –¥–∞–Ω–Ω—ã–µ –≤ store (upsert)
//
// ‚ùå –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (disconnect)


// –ë–ª–æ–∫	           –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è	    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
// Server	         ‚ùå	                   ‚úÖ
// SocketService	 ‚úÖ	                   ‚ùå


// –†–∞–∑–¥–µ–ª—è–µ–º —Ä–æ–ª–∏
// üî¥ –°–µ—Ä–≤–µ—Ä (WebSocketServer)
//
// –ù–ï –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
//
// –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç new WebSocket()
//
// –û–Ω:
//
//     —Å–ª—É—à–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
//
// –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤
//
// –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–º –¥–∞–Ω–Ω—ã–µ
//
// üü¢ –ö–ª–∏–µ–Ω—Ç (WebSocket)
//
// –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
//
// –°–æ–∑–¥–∞—ë—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
//
// –°–ª—É—à–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è


// –ö–õ–ò–ï–ù–¢
//   ‚îî‚îÄ‚îÄ new WebSocket()      ‚Üí –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
//
// –°–ï–†–í–ï–†
//   ‚îî‚îÄ‚îÄ new WebSocketServer ‚Üí –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

// –ï–≥–æ –∑–∞–¥–∞—á–∏ –¢–û–õ–¨–ö–û:
//
//     –ø—Ä–∏–Ω—è—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
//
// –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–ª—é—á
//
// –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å mock-–¥–∞–Ω–Ω—ã–µ
//
// –∏–Ω–æ–≥–¥–∞ ¬´—Ç–µ—Ä—è—Ç—å¬ª –æ–±—ä–µ–∫—Ç—ã
//
// –ù–∏–∫–∞–∫–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤–Ω—É—Ç—Ä–∏.


// –í –º–æ–º–µ–Ω—Ç connection
// ‚úî –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è
// ‚úî –ø—Ä–æ–≤–µ—Ä–∏–ª–∏ –∫–ª—é—á
// ‚úî –∑–∞–ø—É—Å—Ç–∏–ª–∏ interval
//
// –í setInterval
// ‚úî —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∏ –¥–∞–Ω–Ω—ã–µ
// ‚úî –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ ws.send(JSON)
//
// –í close
// ‚úî –æ—á–∏—Å—Ç–∏–ª–∏ interval
// ‚úî –∑–∞–±—ã–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞

// üß† –û—á–µ–Ω—å –≤–∞–∂–Ω–∞—è –º—ã—Å–ª—å (–∑–∞–ø–æ–º–Ω–∏)
//
// WebSocket ‚Äî —ç—Ç–æ –ò–ù–°–¢–†–£–ú–ï–ù–¢
// SocketService ‚Äî —ç—Ç–æ –ê–†–•–ò–¢–ï–ö–¢–£–†–ê
// Store ‚Äî —ç—Ç–æ –°–û–°–¢–û–Ø–ù–ò–ï
// UI ‚Äî —ç—Ç–æ –ö–ù–û–ü–ö–ò –ò –ö–ê–†–¢–ê

// –ñ–ò–¢–¢–Ñ–í–ò–ô –¶–ò–ö–õ –û–ë º–Ñ–ö–¢–ê (–î–£–ñ–ï –í–ê–ñ–õ–ò–í–û)

// Server sends JSON
//       ‚Üì
// SocketService receives
//       ‚Üì
// ObjectsStore.upsert()
//       ‚Üì
// lastUpdate = now
// lost = false
//       ‚Üì
// (no updates...)
// ‚Üì
// cleanUp()
//       ‚Üì
// lost = true
//       ‚Üì
// (after 5 min)
// ‚Üì
// delete object


// üß† 0. –ö–¢–û –ï–°–¢–¨ –ö–¢–û (–æ—á–µ–Ω—å –≤–∞–∂–Ω–æ)
// üß© WebSocket
//
// ‚û°Ô∏è —ç—Ç–æ –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π API –±—Ä–∞—É–∑–µ—Ä–∞
//
// –û–Ω:
//
//     –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
//
// —à–ª—ë—Ç —Å—Ç—Ä–æ–∫–∏
//
// –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏
//
// –ù–ò–ß–ï–ì–û –Ω–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ store, lost, –æ–±—ä–µ–∫—Ç—ã
//
// üß© SocketService
//
// ‚û°Ô∏è —ç—Ç–æ —Ç–≤–æ–π –∫–æ–¥, —Ç–≤–æ—è –ª–æ–≥–∏–∫–∞
//
// –û–Ω:
//
//     —Å–æ–∑–¥–∞—ë—Ç new WebSocket()
//
// —Å–ª—É—à–∞–µ—Ç onmessage
//
// –ø–∞—Ä—Å–∏—Ç JSON
//
// –ø–µ—Ä–µ–¥–∞—ë—Ç –¥–∞–Ω–Ω—ã–µ –≤ store
//
// üß© ObjectsStore
//
// ‚û°Ô∏è —Ö—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
//
// –û–Ω:
//
//     upsert
//
// lost
//
// cleanup
//
// üß© UI (MapView / App)
//
// ‚û°Ô∏è –≤—ã–∑—ã–≤–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è, –Ω–æ –Ω–µ –ª–æ–≥–∏–∫—É

// –∫–ª–∏–µ–Ω—Ç socetService
    // connect() –≤—ã–∑—ã–≤–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–π –∫–æ–¥ ‚Äî –æ–±—ã—á–Ω–æ App –∏–ª–∏ —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ AuthStore.isAuthorized

// –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞:
    //onmessage ‚Äî —ç—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, –ø–∞—Ä—Å–∏—Ç JSON –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –∏—Ö –≤ ObjectsStore —á–µ—Ä–µ–∑ upsert

// üß† –û—á–µ–Ω—å –≤–∞–∂–Ω–∞—è –º—ã—Å–ª—å (–∑–∞–ø–æ–º–Ω–∏)
    //WebSocket ‚Äî —ç—Ç–æ –ò–ù–°–¢–†–£–ú–ï–ù–¢
    // SocketService ‚Äî —ç—Ç–æ –ê–†–•–ò–¢–ï–ö–¢–£–†–ê
    // Store ‚Äî —ç—Ç–æ –°–û–°–¢–û–Ø–ù–ò–ï
    // UI ‚Äî —ç—Ç–æ –ö–ù–û–ü–ö–ò –ò –ö–ê–†–¢–ê

// üß† –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ (–í–ê–ñ–ù–û)
// App —Å—Ç–∞—Ä—Ç—É–µ—Ç
//    ‚Üì
// —Å–æ–∑–¥–∞—ë—Ç—Å—è SocketService (1 —Ä–∞–∑)
// ‚Üì
// –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª–æ–≥–∏–Ω–∏—Ç—Å—è
//    ‚Üì
// App –≤—ã–∑—ã–≤–∞–µ—Ç socketService.connect(key)

// üîå SocketService = —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
// üß† ObjectsStore = –º–æ–∑–≥
// ‚öõÔ∏è –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã = glue + UI
// üîë AuthStore = –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

// 6Ô∏è‚É£ –û—á–µ–Ω—å –≤–∞–∂–Ω—ã–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –º–æ–º–µ–Ω—Ç üß†
//
// –¢—ã —Å–¥–µ–ª–∞–ª –í–°–Å –ü–†–ê–í–ò–õ–¨–ù–û –ø–æ —Å–ª–æ—è–º:
//
//     FormAuth
//   ‚Üì
// AuthStore.login()
//   ‚Üì
// isAuthorized = true
//   ‚Üì
// App useEffect
//   ‚Üì
// socketService.connect()